# 程序员的自我修养 链接、装载与库

- 《Linker and Loader》 by John R Levine
- 《Intel 64 and IA-32 Architectures Software Developer's Manuals》
- 《Linux内核源代码情景分析》
- 《深入理解计算机系统》
- 《深入理解Windows 操作系统系统》 4th
- 《Advanced Programming in the UNIX Environment》 3th

## 第一部分 温故而知新

```C
#include <stdio.h>
int main()
{
  printf("Hello World!");
  return 0;
}
```

- 计算机硬件结构
  - CPU、内存、存储设备、IO设备、总线
- 总线bus结构:CPU、内存、IO控制芯片都是连接到同一根总线上
- 南北桥结构：
  - 北桥芯片（NorthBridge 使用PCI结构）：一端连接CPU、主存、高速图像设备，另一端连接南桥芯片
  - 南桥芯片（SouthBridge 使用ISA总线）：连接低速IO设备
- 单核CPU频率瓶颈：4G Hz
  - 对称多处理器 SMP Symmetrial Multi-Processing:
  - 多核处理器Multi-Processing：
- 软件结构
  - 应用程序 --> 应用程序编辑接口API --> 运行库 -->系统调用接口 -->操作系统内核 --> 硬件接口 -->硬件驱动-->硬件设备
  - API:Application Programming Interface
  - 系统调用接口：往往通过软件中断（software interrupt）方式提供
- 操作系统：
  - 1.为应用程序层提供抽象接口
  - 2.管理硬件资源：主要为CPU、存储器（内存、磁盘等）、IO设备
  - CPU使用：
    - 多道程序的设计，调度策略：分时系统、多任务系统（抢占式分配CPU）
  - 设备驱动：
    - 操作系统->硬件驱动->硬件设备
    - 硬件的抽象：windows：
  - 内存分配
    - 内存使用问题
    - 进程内存的隔离
    - 内存分段使用:segement
    - 内存分页使用：paging,分页大小固定（通常为4K），虚拟页Virtual Page VP 物理页 Physical Page PP 磁盘页 Disk Page DP
      - 虚拟存储依赖CPU的MMU（Memory Management Unit）部件进行页映射
  - 线程Thread
    - LWP 轻量级进程Lightweight Process
    - 组成：线程ID、当前指令指针PC、寄存器集合、堆栈
    - 进程内线程共享：内存空间（代码段、数据段、堆）、进程级资源（全局变量、句柄、信号等）
    - 线程的访问权限：进程内所有数据、其他线程的堆栈
      - 线程的私有存储空间：栈、线程局部存储TLS（Thread Local Storage）、寄存器
      - C中线程私有：局部变量、函数参数、TLS数据
      - C中线程共享：全局变量、堆数据、函数内的静态变量、程序代码、打开的文件
    - 线程的调度与优先级
      - 线程的状态：运行、就绪、等待
      - 线程调度算法：优先级调度、转轮法
    - 线程安全
      - 竞争与原子操作
        - 原子操作：单指令的操作（该操作执行时，不会被其他系统调度中断）
        - 同步与锁：
          - 锁：线程访问资源前尝试获取锁，线程访问资源后是否锁
            - 锁的类型：
              - 二元信号量Binary Semaphore、多元信号量 --- 其他线程可释放 任何进程可见
              - 互斥量Mutex --- 仅能由创建线程释放 任何进程可见
              - 临界区（Critical Section）--- 仅能由创建线程释放 其他进程不可见
              - 读写锁：两种获取方式共享的（share）、独占的（Exclusive）:锁处于自由状态任何方式都可以获取（并将锁置于对应的获取状态）、若锁在共享状态，其他线程可以已共享方式获取，但不能以独占方式获取

| 读写锁状态 | 共享方式获取 | 独占方式获取 |
| ---------- | ------------ | ------------ |
| 自由       | 成功         | 成功         |
| 共享       | 成功         | 等待         |
| 独占       | 等待         | 等待         |

## 第二部分 静态链接

## 2.1 编译和链接

- C/C++源代码到可执行文件
  - 预处理Preprocessing:源代码到预处理的.i文件
  - 编译Compilation:预处理的.i文件到汇编代码
  - 汇编Assembly:汇编代码到机器指令
  - 链接Linking:多文件链接到最终可执行文件
- 词法分析
  - 输入：源代码
  - 输出：记号Token
  - 工具：扫描器，EG:lex
- 语法分析
  - 输入：记号Token
  - 输出：语法树Syntax tree
  - 语法分析器
  - 工具：ycc
- 语义分析
  - 输入：语法树
  - 输出：语法树
  - 语义分析器
- 中间语言生成
  - 输入：语法树
  - 输出：中间代码（三地址码、P-代码）
- 目标代码生成与优化
  - 