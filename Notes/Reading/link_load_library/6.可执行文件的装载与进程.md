# 装载与动态链接

## 6.可执行文件的装载与进程

### 6.1 进程的虚拟地址空间

- 程序与进程的区别？
  - 程序是静态概念，是一个预编译好的指令和数据的集合的文件
  - 进程是动态概念，是程序运行的过程
- 进程的虚拟地址空间大小和可用范围问题：
  - 虚拟地址空间大小取决于硬件CPU位数确定，即寻址能力
  - 程序角度，即依据指针所占的空间范围计算虚拟地址空间
  - 使用范围：整个指针可访问的范围 去掉操作系统的占用部分
- 如何扩展程序的使用空间，即扩展指针可访问的常规范围?
  - PAE:物理地址扩展，使用操作系统提供的窗口映射方法，根据需要将同一块虚拟内存映射到多个不同的内存

### 6.2 装载的方式

- 覆盖装载:覆盖管理器
  - 将程序进行分块，并决定何时该块被加载和替换，调用目标必须在内存中程序才能执行
- 页映射：映射管理器
  - 将内存和磁盘中的数据按照页进行分割，实现以页为单位的数据加载
  - 页置换算法：LUR

### 6.3 从操作系统看可执行文件的装载

- 进程建立
  - 1.创建独立的虚拟地址空间
    - 虚拟空间：一组页函数将各个页映射到相应的物理空间，创建虚拟地址空间实质为创建映射函数所需的数据结构
  - 2.读取可执行文件，建立虚拟地址空间与可执行文件的映射
    - 可执行文件与页的映射关系：ELF文件段与页映射问题
    - VMA 虚拟内存区域（VMA）或虚拟段：虚拟空间中的一个段
  - 3.将CPU寄存器设置为可执行文件的入口地址
- 页错误
  - 进程建立后，真正的指令和数据并没有加载到内存中，仅仅是建立映射关系，
  - 当CPU根据入口地址开始执行指令时，根据映射关系查找虚拟页
  - 若该页为空（即未加载数据），CPU将控制权交给操作系统，操作系统查询虚拟映射数据结，查找空页面VMA，计算页在可执行文件中的偏移，物理内存分配物理页面并与虚拟页建立映射，加载数据
  - 继续执行原CPU指令，随着指令执行不断出现页错误，操作系统不断进行处理，因此出现虚拟内存管理

### 6.4 进程虚拟存储空间分布

- 系统页映射单位：页长度
- ELF文件段长度大小不一，读写权限不一
- 方案一：
  - 相同权限的段，合并到一起进行页映射，成为一个段，Segment
  - ELF文件是按照Segment存储
  - ELF可执行文件中含有一个专门用于保存Segment信息的数据结构：程序头表Program Header Table，Elf32_Phdr
- 堆和栈
  - 一个进程中的堆和栈 分别对应一个VMA
  - 匿名虚拟内存区域：指没有映射到ELF文件中的VMA，通常指Heap\Stack\vdso
  - vdso:内核模块
- VMA划分：
  - 代码(指令、程序)VMA：只读、可执行、有文件映射
  - 数据VMA：读写、可执行、有文件映射
  - 堆VMA：读写、可执行、无文件映射，匿名，向上扩充
  - 栈VMA：读写、不可执行、无文件映射，匿名，向下扩充
- [堆最大申请数量](./6.loading_process.c)
- 段地址对齐
  - 原因：操作系统通过虚拟内存的页映射完成可执行文件的加载，页映射中，页是最小单位
  - 在映射时，即将一段物理内存与虚拟内存建立映射关系，内存空间的长度必须是页大小的整数倍，而且映射的起始地址也必须是页大小的整数倍
  - 限制：映射空间的长度、映射空间的起始地址