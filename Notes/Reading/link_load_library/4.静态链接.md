# 静态链接

- 链接
  - 1.空间分配：分配段虚拟地址
  - 2.确定符号地址
  - 3.

## 4.1 空间与地址分配

- 链接：多个目标文件合并为一个可执行文件
- 问题：可执行文件的代码和数据由所有的输入目标文件合并得到，如何合并各个输入文件的段到输出文件？输出文件中的空间如何分配给输入文件？
- 解决：
  - 1.按序叠加：将输入的目标文件按照次序叠加合并
    - 问题：在大量输入文件时，会出现大量的零散的段，导致浪费空间（对齐要求）
  - 2.相似段合并：将输入文件的相同性质的段合并到一起
    - 链接器的空间和地址分配：输出的可执行文件中的空间分配；装载后虚拟地址空间的分配；（目前的空间分配只关注于虚拟地址空间分配）
    - 一般采用：两步链接方法 Two-pass Linking
      - 1.空间与地址分配
      - 2.符号解析与重定位
- 编译命令：`gcc -c a.c b.c`
- 链接命令：`ld a.o b.o -e main -o ab`
  - `-e main`:指定程序入口，ld默认程序入口为`_start`
  - `-o ab`:指定输出文件
- 符号地址确定
  - 符号地址=段虚拟地址+偏移

## 4.2 符号解析与重定位

- 重定位
  - 主要是外部符号的重定位
  - 编译：函数的起始地址都是0x0000;外部符号都是临时假地址
  - 链接：函数起始地址变成真实虚拟地址；外部符号地址修正为真正虚拟地址或者指令修正
- 重定位表
  - 用途：告知链接器哪些指令的哪些部分需要被调整，以及如何调整
  - 重定位表（重定位段）：`.rel.[被重定位段名]`
  - 查看目标文件重定位表：`objdump -r a.o`
- 符号解析
  - 未定义的符号 应在全局符号表中查找，未找到则报错
- 指令修正方式
  - 不同指令具有不同的寻址方式
    - 近址寻址 远址寻址
    - 绝对寻址 相对寻址
    - 寻址长度：8位 16位 32位 64位
    - 绝对近址32位寻址 相对近址32位寻址
  - 重定位入口类型x86
  - R_386_32 : 1 绝对寻址修正 S+A
  - R_386_PC32: 2 相对寻址修正 S+A-P
    - S:符号实际地址;A：保存在被修正位置的值；P：被修正位置（相对于段开始的偏移或虚拟地址）
- COMMON块
  - 链接器如何处理同一符号定义在不同文件中，而且类型不同的时的结果符号的类型问题？
  - 本质：编译器允许不同类型的弱符号存在，编译器不支持符号类型
    - 两个以上的强符号类型不一致--->链接报错：多重定义错误
    - 一个强符号多个弱符号类型不一致：结果类型与强符号相同
    - 多个弱符号类型不一致：结果类型与弱符号中占空间最大的符号相同
  - 将未初始化的变量不以COMMON形式存在：
    - 1.GCC编译参数：`-fno-common`
    - 2.__attribute__扩展:`__attribute__((nocommon))`，EG:`int gloabl_int_var __attribute__((nocommon))`

## 4 C++相关问题

- 重复代码消除
  - 模版处理：每个模版实例单独放到一个段里，每个段只包含一个模版实例
  - 虚函数、外部内联函数、默认构造函数、默认拷贝构造函数、赋值操作符等
- 函数级别链接
  - VC++，让所有的函数都单独保存到一个段里，在链接用到时合入输出文件，否则抛弃该段
  - GCC 编译项：`-ffuntionsections` `-fdata-sections`
- 全局构造与析构
  - ELF特殊段
    - .init:可执行指令，进程初始化代码
    - .fini：进程终止代码
- C++与ABI
  - 问题：不同的编译器产生的目标文件能进行互相链接吗？
    - 1.链接器支持不同类型的目标文件的文件格式，PE/COFF与ELF
    - 2.其他限制：同样的目标文件格式、同样的符号修饰标准、变量的内存分布方式、函数调用方式，即ABI兼容性问题
  - ABI：application binary interface,执行代码二进制兼容性相关内容
    - ABI与API
      - 1.接口层面不一样：API值源代码级别的接口；ABI：二进制层面接口
  - ABI兼容性问题：
    - 硬件、编程语言、编译器、链接器、操作系统等
  - 静态链接
    - ar压缩程序：将多个目标文件压缩到一个文件中，并进行编号和索引
    - `ar `
    - 查看压缩文件内容：`ar -t [zip].a`
    - VC++提供了lib.exe功能与ar类似；`lin /LIST [zip].lib`
    - 解压目标文件：`ar -x [zip].a`
    - GCC显示编译过程：`gcc -static--verbose -fno-builtin hello.c`,'-fnobuiltin':关闭内置函数优化
    - linux GCC编译过程：
      - 1.使用cc1将源代码编译成临时汇编文件
      - 2.使用as程序将临时汇编文件汇编成临时目标文件
      - 3.调用collect2（ld链接器包装）程序对临时目标文件进行链接
    - 通常静态运行库内一个目标文件只有一个函数

## 4.6 链接过程控制

- 默认情况下使用默认的链接规则对目标文件进行链接，但是特殊的程序需要对链接过程进行控制
- 特殊程序：操作系统内核、BIOS、引导程序、无操作系统运行的程序、脱离操作系统硬盘分区的软件、内核驱动等
- 链接控制：指定各个段虚拟地址、指定段名、指定段存放顺序
- 内容控制：输出格式、调试信息、库文件、目标文件等
- windows操作系统内核：
  - ntoskrnl.exe - windows/system32/ntoskrnl.exe
- 