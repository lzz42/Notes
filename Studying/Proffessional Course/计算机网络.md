# 计算机网络 - 谢希仁

![alt](计算机网络.png)

## Chapter 01 概述

- Glossary
- ISP Internet Service Provider 因特网服务提供者
- C/S -Client Server  客户端服务器
- P2P - peer-to-peer 对等连接
- 带宽 - bandwidth
- 吞吐量 - throughput
- 时延 - delay latency
- 发送时延 -  transmission delay
- 传播时延 - propagation delay
- 总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延
- 网络协议的三要素：
  - 1.语法 - 数据和控制信息的结构或格式；
  - 2.语义 - 发送的控制信息、接收响应、接收动作；
  - 3.同步 - 事件实现顺序；
- 分层后功能：
  - 1.差错控制
  - 2.流量控制
  - 3.分段和重装
  - 4.复用和分用
  - 5.连接建立和释放

| OSI协议    | TCP/IP     | 五层协议模型 |
| ---------- | ---------- | ------------ |
| 应用层     | 应用层     | 应用层       |
| 表示层     | 应用层     | 应用层       |
| 会话层     | 应用层     | 应用层       |
| 运输层     | 运输层     | 运输层       |
| 网络层     | 网际层     | 网络层       |
| 数据链路层 | 网络接口层 | 数据链路层   |
| 物理层层   | 网络接口层 | 物理层       |

- OSI - 七层协议体系：物理层》》数据链路层》》网络层》》运输层》》会话层》》表示层》》应用层
- TCP/IP - 四层协议：网络接口层》》网际层》》运输层》》应用层
- 五层协议模型：物理层》》数据链路层》》网络层》》运输层》》应用层
- 每一层大致作用：
  - 物理层 physical layer ：

| 层名称     | 英文              | 传输单位       | 作用                                    | 其他                        |
| ---------- | ----------------- | -------------- | --------------------------------------- | --------------------------- |
| 应用层     | application layer | 数据           | 为用户提供服务                          | HTTP SMTP DNS RTP H.323 SIP |
| 运输层     | transport layer   | 报文段 segment | 提供复用和分用 TCP UDP                  | TCP UDP   SCTP              |
| 网络层     | network layer     | IP数据报       | 将上层数据封装分组或包                  | IP                          |
| 数据链路层 | data link layer   | 帧 frame       | 控制数据传输，将上层数据封装帧+控制信息 | IP                          |
| 物理层     | physical layer    | byte流         | 物理传输信号                            |                             |

## chapter 02 物理层

- 数据通信系统模型
  - 源系统----传输系统----目的系统
- 信道 channel
  - 定义：向某一方向传送信息的媒体，一条通信电路包含：一条发送信道、一条接收信道
  - 通信方式：
    - 1.单向通信 - 单工通信
    - 2.双向交替通信 - 半双工通信
    - 3.双向同时通信 - 全双工通信
  - 基带信号、调制（modulation）、载波carrier
  - 基带调制：对基带信号进行波形变换
  - 带通调制：把基带信号频率范围移动到较高频段
    - 1.调幅AM 2.调频FM 3.调相PM
  - 信道的极限容量：
    - 1.信道能够通过的频率范围；
    - 2.信噪比
- 物理层传输媒体：
  - 1.双绞线、光缆、卫星
- 信道复用技术
  - 频分复用FDM、时分复用、统计时分复用
  - 波分复用WDM
  - 码分复用CDM - CDMA码分多地址

## chapter 03 数据链路层

- 目的：在物理层的基础上，控制数据的传输（发送、接收）；
- 具体工作：发送：将网络层的数据包装成帧发送到数据链路上，接收：从数据链路上接收到的帧的数据交给网络层；
- 步骤：1.封装成帧（发送）；2.透明传输（发送）；3.差错校验（发送/接收）；
- 硬件设备：网络适配器(网卡)
- 两种类型：
  - 点对点信道
  - 广播信道
- 点对点信道
  - 封装帧：`SOH [数据]EOT`，SOH - 0x01,EOT - 0x04
  - 透明传输：解决数据中出现SOH EOT的问题  - 字符填充（字节填充）- 加ESC转义字符，若出现ESC转义字符则再添加一个ESC,ESC - 0x1B
  - 差错校验：解决传输过程中比特差错问题，误码率EBR - 采用CRC 循环冗余检验（待发送数据后添加n位校验码）
- PPP - 点对点协议
  - 组成：
    - 1.将IP数据报封装到串行链路的方法；
    - 2.链路控制协议LCP：建立、配置、测试数据链路；
    - 3.网络控制协议NCP：
  - PPP协议帧格式

## chapter 04 网络层

- 网络层主要解决问题？提供何种服务？
- 重要概念
  - 1.虚拟互联网络
  - 2.IP地址与物理地址
  - 3.子网掩码和CIDR
  - 4.路由选择协议
  - 5.VPN NAT
  - 6.MPLS

### 4.1 网络层提供的基本服务

- 网络层提供哪两种基本服务？服务特点？

### 4.2 网际协议IP

- IP协议是什么？解决什么问题？
- IP基本结构？

### 4.3 划分子网与构造超网

- 为什么要划分子网？如何划分子网？
- 为什么要构造超网？如何构造超网？

### 4.4 ICMP

- ICMP解决什么问题？
- 如何实现ICMP？

### 4.5 互联网路由选择协议

- 路由选择协议为解决什么问题？
- 路由选择协议有哪些？

### 4.6 IPv6

- IPv6存在意义？
- IPv6基本结构
- IPv6与IPv4区别
- 如何从IPv4到IPv6过渡？

### 4.7 IP多播

- 什么是IP多播？
- IP多播为解决什么问题？
- 如何实现IP多播？

### 4.8 VPN和NAT

- 什么是VPN、NAT？
- VPN和NAT为解决什么问题？

### 4.9 MPLS

- 什么是MPLS?
- MPLS存在意义？
- MPLS应用

## Chapter 05 运输层

- 运输层主要解决什么问题？主要提供什么服务？
- 重要概念：
  - 1.逻辑通信
  - 2.端口和套接字
  - 3.UDP
  - 4.TCP
  - 5.不可靠网络上的可靠传输
  - 6.停止等待协议
  - 7.ARQ协议
  - 8.TCP-滑动窗口、流量控制、拥塞控制、连接管理

### 5.1 运输层协议概述

- 运输层与网络层区别：
  - 网络层为主机之间提供逻辑通信
  - 运输层为应用进程之间提供端到端的逻辑通信
- 运输层的重要功能：
  - 1.复用 multipexing:发送方不同进程可共用同一运输层协议传输数据；
  - 2.分用 demultipexing:接收方运输层能够去掉报文首部后，将数据正确交付目的应用进程；
  - 3.差错检测：接收方对收到的报文进行差错检测
- 运输层目前只有两中运输协议：
  - UDP：无连接，用户数据报协议 User Datagram Protocol，基于IP协议，TPDU：UDP用户数据报
  - TCP：面向连接,传输控制协议 Transport Control Protocol，基于IP协议，TPDU：TCP报文段 segment
- 名词
  - TPDU Transport Protocol Data Unit 运输协议数据单元
- 应用成协议和运输层协议对照表

| 应用           | 应用层协议            | 运输层 |
| -------------- | --------------------- | ------ |
| 名字转换       | DNS 域名系统          | UDP    |
| 文件传送       | TFTP 简单文件传送协议 | UDP    |
| 路由选择协议   | RIP 路由信息协议      | UDP    |
| IP地址配置     | DHCP 动态主机配置协议 | UDP    |
| 网络管理       | SNMP 简单网络管理协议 | UDP    |
| 远程文件服务器 | NFS 网络文件系统      | UDP    |
| IP电话         | 专用协议              | UDP    |
| 流式多媒体通信 | 专用协议              | UDP    |
| 多播           | IGMP 网际组管理协议   | UDP    |
| 电子邮件       | SMTP 简单邮件传送协议 | TCP    |
| 远程终端接入   | TELNET 远程终端协议   | TCP    |
| 万维网         | HTTP 超文本传输协议   | TCP    |
| 文件传送       | FTP 文件传送协议      | TCP    |

- 运输层端口
  - 协议端口号 protocol port number(端口):仅用于本地计算机进程和运输层交互的层间接口
  - TCP/IP：使用16位端口号：0-65535
- 端口号分类：
  - 1.服务器使用的端口号
    - 1.1 熟知端口号或系统端口号：0-1023 (www.iana.org)
    - 1.2 登记端口号：1024-49151
  - 2.客户端使用的端口号：49152-65535

| FTP | TELNET | SMTP | DNS | TFTP | HTTP | SNMP | SNMP(trap) | HTTPS |
| --- | ------ | ---- | --- | ---- | ---- | ---- | ---------- | ----- |
| 21  | 23     | 25   | 53  | 69   | 80   | 161  | 162        | 443   |

### 5.2 UDP

- UDP特点：
  - 1.无连接：发送前不需要建立连接、发送结束不需要释放连接；
  - 2.使用尽最大努力交付，不保证可靠交付
  - 3.面向报文：一次发送一个报文，一次交付一个完整报文;发送方对上层交付的报文，添加首部后就交付给IP层，即不合并也不拆分，保留报文的边界；接收方收到IP层交付的报文，去除首部后交付给上层;
  - 4.没有拥塞控制
  - 5.支持一对一、一对多、多对一、多对多交互通信
  - 6.首部开销小：首部只有8字节
- UDP首部格式
  - UDP数据报=数据字段+首部字段

$$
\begin{aligned}
UDP数据报 & = IP首部 + IP数据报数据部分\\
& = IP首部 + UDP首部 + UDP数据部分\\
& = IP首部 + 源端口(2) + 目的端口(2) + 长度(2) + 检验和(2) + UDP数据部分\\
\end{aligned}
$$

$$
\begin{aligned}\\
UDP首部
& = 源端口(2)：源端口号，需要回信时选用，不需要时，用全0\\
& = 目的端口(2)：目的端口号，终点交付报文时必须\\
& = 长度(2)：UDP用户数据长度，最小值为8（仅首部）\\
& = 检验和(2)：检测UDP数据报在传输中是否有差错，若有差错则丢弃\\
\end{aligned}
$$

为计算首部中的校验和，需要在首部前添加12字节伪首部，组成临时用于计算校验和的数据报，仅有用计算校验和

- 计算过程
  - 1.生成：含伪首部的数据报不是偶数字节补0，按二进制反码计算16位和，结果取反放入检验和；
  - 2.检验：含伪首部的数据报，按二进制反码计算16位和，结果全1时，无差错时；

$$
\begin{aligned}\\
伪首部
& = 源IP地址(4)\\
& = 目的IP地址(4)\\
& = 长度(2)：UDP用户数据长度，最小值为8（仅首部）\\
& = 检验和(2)：检测UDP数据报在传输中是否有差错，若有差错则丢弃\\
\end{aligned}
$$

### 5.3 TCP

- TCP特点：
  - 1.面向连接的运输协议；
  - 2.每条TCP连接只能有两个端点（endpoint），即点对点通信；
  - 3.提供可靠交付服务：无差错、不丢失、不重复、按序到达；
  - 4.提供全双工通信；
  - 5.面向字节流：流-流入到进程或从进程流出的字节序列，不保证发送方的数据块和接收方数据块大小一致，但流保证一致；
- 名词定义：
  - 套接字（socket）或插口：TCP连接的端点，IP地址+端口号

### 5.4 可靠传输工作原理

- 理想传输条件（自然实现可靠传输）：
  - 1.传输信道不产生差错；
  - 2.接收方总能及时处理接收到的数据

#### 5.4.1 停止等待协议RDT

- 概述：发送方每发送完一个分组等待接收方确认，收到接收方确认后再发送下一个分组；
- 无差错情况：
  - A发送分组M给B，等待B回复确认；
  - B收到分组M，进行验证，验证通过，回复接收M确认；
- 出现差错：
  - A发送分组M给B，等待B回复确认；
  - B收到分组M，进行验证，验证失败，丢弃该分组，不发送回复确认；
  - A等待回复超时，重复发送分组M，并等待B确认；
  - 注意：
    - 1.发送者暂时保留已发送数据的副本，以用来重复发送；
    - 2.分组和确认分组都必须进行编号；
    - 3.超时时间设定；
- 确认丢失和确认迟到：
  - 情况：B发送的回复确认丢失，或者A超时重传；
  - B收到重传的分组后：
    - 1.丢弃重复分组，不上上层交付；
    - 2.向A发送确认；
- 自动重传请求ARQ：Automatic Repeat reQuest
- 信道利用率：
  - $T_D:A发送分组所需时间 = 分组长度/数据率$
  - $T_A:B发送确认分组需要时间$
  - $RTT:往返时间$

$$
信道利用率:U = \frac{T_D}{T_D + RTT + T_A}
$$

- 连续ARQ协议
  - 发送窗口
  - 发送方每收到一个确认，把滑动窗口向前移动一个分组位置
  - 接收方：采用累积确认，收到多个分组后，对按序到达的最后一个分组发送确认

### 5.5 TCP报文段首部

- 固定20字节+4n字节的选项

### 5.6 TCP可靠传输的实现

- 以字节为单位的滑动窗口

![alt](res\计算机网络-5-TCP-1.png)

![alt](res\计算机网络-5-TCP-2.png)

  - 发送方的滑动窗口：
    - 主要用途：在没收到接收方的确认情况下，发送方可以把窗口内的数据都发送出去，窗口内数据必须被暂存以备重新发送
    - 发送窗口大小限制：不能超过接收方的滑动窗口大小；可以根据网络拥塞状态减小窗口大小；不能超过发送缓存；
    - 窗口内数据：已发送数据（未收到确认）+未发送数据
    - 窗口变化：
      - 不动：未收到确认
      - 前移：收到确认
  - 接收方的滑动窗口：
    - 主要用途：暂存非按序到达的数据，限定发送数据量
    - 大小限制：不能大于接收缓存大小
- 注意：
  - 1.发送方窗口大小根据接收方窗口设置，但同一时刻，发送窗口和接收窗口大小并非总是大小一致：原因：网络传输延迟；网络拥塞发送方调整大小；
  - 2.对不按序到达数据的处理：通常暂存接收窗口，等待接收到缺少的字节后，按序交付上层；
  - 3.接收方必须具有累积确认功能：标准规定确认推迟不应超过0.5s；
- 超时重传时间的选择
  - 自适应算法：记录一个报文的发出时间，以及相应的确认时间，时间差为RTT，TCP保留RTT的一个加权平均往返时间RTTs（即平滑的往返时间）：计算公式

$$
New\ RTTs = (1 - \alpha) \times (old\ RTTs) + \alpha \times (new\ RTT\ sample)\\
 0 \leq \alpha <1,RFC 建议:\alpha = 1/8
$$

超时计时器设置的超时重传时间：RTO(RetransmissionTime-Out):
$RTO = RTTs + 4*RTT_D,RTT_D为RTT的偏差的加权平均值$</br>
Karn算法

- GBN协议
  - 接收方累积确认
- 选择确认协议SR SACK-SR
  - 解决问题：收到报文无差错，但未按序到达，缺少中间数据时，要求只重传缺少数据而不重传已正确收到数据
  - 使用选择确认，需要在TCP建立连接时在首部选项添加“允许SACK”选项，首部长度最多40B，指明一个边界用4B（32位序号），指明一个字节块需要2个边界，还需要另外两个字节：一个指明SACK选项，一个指明选择长度

### 5.7 TCP流量控制

- 利用滑动窗口实现流量控制
  - 接收方发送报文丢失导致的等待死锁问题：持续计数器 - 零窗口探测报文
- TCP传输效率
  - TCP报文发生时机：
    - 1.TCP维持一个等于MSS（最大报文长度）的变量，只有缓存数据达到该值，即可发送；
    - 2.发送方应用指定发送数据段，即推送操作；
    - 3.发送方的计时器时间到了，开始发送数据；
  - Nagle算法：
    - 若发送应用把要发送数据逐个字节送到TCP的发送缓存，则发送方把第一个字节的数据发送出去，然后把后面的数据进行缓存。当发送方接收到第一个数据的字符确认后，再把发送缓存中的所有数据组装成报文发送，同时继续对随后到达的数据进行缓存。只有在接收到前一个报文确认后才继续发送下一个报文。
    - Nagle规定：当到达的数据已达到发送窗口大小的一半或已达到报文段最大长度时，立即发送一个报文；
  - 糊涂窗口综合征（silly windows syndrome）
    - 1.前提：TCP接收窗口已满，上层应用一次只从接收缓存读取1字节，接收方向发送方发送确认，窗口值设置为1；发送方发送1字节，接收方回放确认，仍将窗口值设置为1;
    - 解决：接收方等待一段时间；接收方等待接收缓存已有一般空闲；

### 5.8 TCP拥塞控制

- 拥塞控制的一般原理
  - 网络资源、拥塞 congestion
  - 拥塞控制：防止过多的数据注入到网络中。使网络中的路由器或链路不致过载
  - 拥塞控制前提：网络能够承受现有的网络负荷；
  - 拥塞控制：全局性控制，涉及到所有主机、所有路由器、以及与降低网络传输性能的因素；
  - 流量控制：点对点通信量的控制，抑制发送端发送的数据；
- TCP拥塞控制方法
  - 假定：
    - 1.数据单向传送，对方只传送确认报文；
    - 2.接收方总有足够大的缓存空间，发送窗口大小由网络的拥塞程度决定；
  - 慢开始和拥塞避免
    - 发送方：维持一个拥塞窗口cwnd的状态变量，拥塞窗口大小取决于网络拥塞程度，发送方让发送窗口等于拥塞窗口；
    - 发送原则：网络没有出现拥塞，就可以增大拥塞窗口，网络出现拥塞，减小拥塞窗口
    - 判断网络出现拥塞机制：确认超时
    - 慢开始算法：
      - 主机开始发送数据时，由小到大逐渐增大发送窗口，一般规定初始cwnd值为不超过2-4个SMSS（最大报文段）
      - 每收到一个对新的报文段确认后，可以把cwnd增大最多一个SMSS，cwnd每次增大量 = min（N,SMSS）,N为刚收到确认的字节数
      - 每经过一个传输轮次，拥塞窗口cwnd加倍，传输轮次的时间：RTT
      - 防止cwnd增长过大：设置慢开始门极限ssthresh状态变量值：当cwnd < ssthresh时，采用慢开始算法；当cwnd>ssthresh时，采用拥塞避免算法；当cwnd=ssthresh时，两者均可
    - 拥塞避免：
      - 让cwnd缓慢增大，每经过一个RTT，cwnd加1
  - 快重传
    - 让发送方尽快知道个别报文段丢失
    - 立即发送确认