# CH 11 文件系统实现

## 1.文件系统结构

- 磁盘特点：
  - 可以原地重写
  - 可以直接访问磁盘上任意一块的信息
- 分层设计的文件系统
- 文件系统的设计问题：
- 如何定义文件系统对用户的接口
- 创建数据结构和算法来将逻辑文件系统映射到物理外存设备上
> 应用程序->逻辑文件系统->文件组织系统->基本文件系统->IO控制->设备
- IO控制  由设备驱动程序和中断处理程序组成，实现内存与磁盘之间的信息传输
- 基本文件系统 向设备发送指令
- 文件组织模块 管理文件逻辑块和物理块
- 逻辑文件系统 管理元数据：包括文件系统的所有结构数据，不包括实际数据结构
  - 通过FCB维护文件结构，FCB 文件控制块 File Control Block
- Unix：文件系统 UFS - 基于FFS
- Windows：文件系统 FAT FAT32 NTFS
- Linux：ext2 ext3

## 2.文件系统实现

- 文件系统概述
- 引导控制块：引导操作系统所需信息，引导块或分区引导扇区
- 卷控制块：包括卷详细信息，超级块或主控文件表
- 内存中的文件系统信息：
  - 安装表：所有安装卷信息
  - 目录结构缓存：保存最近访问的目录信息
  - 系统范围内打开的文件表：记录已打开文件的FCB和进程数量
  - 单个进程打开的文件表：一个指向系统范围打开文件表的指针和其他信息
- 创建新文件
  - 1.逻辑文件系统：分配FCB
  - 2.将目录信息读入内存；
  - 3.使用新文件名更新FCB和目录
  - 4.结果写会磁盘
- 对于目录的特殊处理：有的操作系统将目录视为文件，使用类型域标识是否为目录，有的操作系统将目录和文件分开调用
- 打开文件
  - 1.调用open到文件系统
  - 2.首先搜索系统范围打开文件表查找该文件，是否被其他进程使用，是：单个进程打开文件表中新建一项，指向系统范围打开文件表
  - 3.根据文件名搜索目录结构，找到文件后，复制其FCB到系统范围打开文件表
  - 4.进程打开文件表中新增条目，通过指针将系统范围打开文件表条目和其他域关联
  - 5.返回一个指向单个进程的打开文件表中合适条目的指针（UNIX：文件描述符，windows：文件句柄）
  - 6.关闭文件：删除一个相应的单个进程打开文件表的条目，系统范围打开文件表相应条目打开数量递减，若所有使用该文件的用户关闭文件，则系统范围打开文件表中该对应条目会删除
- 分区与安装
- 分区
- 生分区 raw：没有文件系统，EG:UNIX交换空间、部分DB
- 熟分区 cooked：有文件系统
- 引导信息：一组有序块，并作为镜像文件读入内存，指导如何启动一个操作系统
- 根分区 root partition：包括操作系统内核或其他系统文件，在引导时装入内存
- OS加载操作系统
  - 1.引导时加载根分区内容（装入内存），其他分区根据OS自动装入或者手动装入
  - 2.OS验证设备上的文件系统是否有效，若无效则检验分区是否一致，根据需要进行纠正
  - 3.OS在内存的装入表中注明已装入的文件系统和文件系统类型

### 虚拟文件系统 VFS

- OS在多个文件系统类型之间无缝切换，分开基本系统调用和实现细节
- 三个层次
  - 1.文件系统接口：open read write close 文件描述符
  - 2.VFS接口：定义VFS接口，将文件系统的通用操作和具体实现分开；提供网络上唯一标识一个文件的机制；
  - 3.多个具体的文件系统类型
- Linux VSF定义的4种主要对象：
  - 索引节点对象 inode object：表示一个单独的文件
  - 文件对象 file object：表示一个打开的文件
  - 超级块对象 superblock object：表示整个文件系统
  - 目录条目对象 dentry object：表示一个单独的目录条目
- 虚拟文件系统 VFS
- 屏蔽各种文件系统的差异
- VFS对每种类型对象定义一组必须实现的操作，该类型对象都包含一个指向函数表的指针，该函数表列出特定对象的操作函数；

## 3.目录实现 - 文件与目录的实现方式

- 目录分配算法和目录管理算法
- 线性列表：存储文件名和数据块指针
  - 缺点：查找文件需要线性搜索
- 哈希表：
  - 使用线性表存储目录条目
  - 使用哈希结构数据：将文件名哈希计算到一个值，放入线性表（需要解决哈希冲突）
  - 困难:固定大小和哈希函数对于大小的依赖
  - 解决：chained-overflow 哈希表

## 4.分配方法 - 磁盘空间分配方法

- 如何为文件分配空间
  - 每个文件在磁盘上占用一组连续的块，磁盘地址定义线性序列
- 连续分配 contiguous allocation
  - 优点：
    - 1.连续访问块时不需要移动磁头，需要移动磁头时只需移动一个磁道，即：寻道数最小，寻道时间最小
    - 2.访问容易，支持顺序访问和直接访问
  - 问题：
    - 为新文件找到空间，即选择空闲空间问题，动态存储分配 dynamic storage-allocation
    - 外部碎片问题 external fragmentation
    - 解决：确定一个文件需要多少空间问题 扩展extent
- 链接分配 linked allocation
  - 每个文件是磁盘块的链表；磁盘块分部在磁盘的任何地方，目录包括文件第一块指针和最后一块指针，每个块都有指向下一块的指针，用户不能使用这些指针
  - 优点：
    - 1.没有外部碎片
    - 2.不需要说明文件大小
    - 3.无需合并磁盘空间
  - 缺点：
    - 1.文件顺序访问，磁盘寻道慢，不能有效的支持文件的直接访问
    - 解决：
      - 将多个块组成簇cluster，按照簇来分配，提高了磁盘传输并降低了块分配和空闲列表管理所需空间
      - 代价：增加了内部碎片；
    - 2.链接分配的可靠性问题，即指针链接的可靠性
      - 解决：
        - 1.采用双向链表，或者在每个块中存入文件名和相对块数;
        - 2.文件分配表 FAT：
          - a.每个卷的开始部分用于存储FAT;
          - b.每一个块在FAT中有一项;
          - c.目录条目含有文件首块的块号码，根据块号码索引FAT条目包含文件的下一块号码；
- 索引分配 indexed allocation
  - 解决块的直接访问问题
  - 实现：
    - 1.每个文件都有索引块（磁盘地址数组）；
    - 2.索引块第i个条目指向文件第i个块，目录条目包括索引块地址；
    - 3.要读或写第i块，通过索引块的第i个条目指针找到要读的块；
    - 4.要添加写入第i块，从空闲块管理器获取一块，将该块地址新增到索引块的第i个条目；
  - 问题：索引块浪费空间，在一个文件只有一块或者两块时，也必须分配一个完整的索引块，因此需要解决索引块的大小问题？
    - 1.链接方案：一个索引块为一个磁盘块，大文件时，可以将多个索引块连接起来
    - 2.多层索引：第一级索引指向第二级索引块，第二级索引指向文件块或者第三级索引；
    - 3.组合方案：包含固定数量的链接索引和多个多级索引；
- 总结：
  - 判断依据：1.存储效率；2.数据块访问；
  - 访问类型：1.顺序访问；2.随机访问；

## 5.空闲空间管理

- 记录磁盘的空闲空间，用以进行空间分配
- 使用空闲空间链表free-space list :记录空闲磁盘空间（未分配的空间）；
- 两个操作：
  - 新增文件：需要从空闲空间链表中找到记录的空闲块分配空间 - 搜索并删除条目；
  - 删除文件：需要将文件的磁盘空间记录到空闲空间表中 - 新增条目；
- 实现方式
  - 位向量：空闲空间链表表示为位图或者位向量，每块用一位表示,已使用为0，未使用（空闲）为1，查找第一块和连续块操作简单；
    - 缺点：主要涉及位向量的存储，对于大内存不使用；
  - 链表：将所有的空闲块用链表连接：
    - 做法：将第一块空闲块指针放到操作系统特殊位置并缓存到内存，第一块空闲块内包含下一块空闲块指针，依次类推；
    - 缺点：效率不高，遍历空闲块时需要从第一块开始查找
  - 组：改进空闲链表，对于N个空闲块的空闲地址，前N-1个为空最后一个包含另外N个空闲块地址，如此继续；
  - 计数：空闲空间链表,多个连续块需要同时分配和释放，连续分配以及使用簇；
    - 做法：空闲空间链表每一项纪录第一块地址和连续块数量；

## 6.效率与性能

- 效率：
  - 1.影响效率的主要因素：磁盘分配和目录管理算法；
  - 其他因素：保留文件目录条目的数据结构；访问数据的指针大小；
- 性能：
  - 缓冲缓冲
  - 页面缓冲Page cache：使用虚拟内存技术，将文件数据作为页而不是文件系统的块来缓存，一般缓存进程页和文件数据，称为统一虚拟内存：unified virtual memory
  - 双重缓存double caching：
    - Eg：读文件，两种方式：内存映射，标准系统调用；内存映射需要从系统读文件数据到缓冲缓存中，然后缓冲缓存复制到页面缓存中，然后从页面缓冲读取数据
  - 优化页面缓存：1.马上释放free-behind；2.预先读取read-ahead；
  - 系统写入方式：同步写（不需要缓存），异步写（需要缓存），
  - 异步写入：数据写入磁盘文件时，写入页会先放入缓存中，并且磁盘驱动器根据磁盘地址对输出队列进行排序（最小化磁盘寻道和优化写数据），系统在方便时异步将数据写入磁盘；

## 7.恢复

- 文件和目录同时存在于内存和磁盘中，必须保证数据的一致性
- 目录结构和磁盘数据一致
- 一致性检查 consistency checker
- 备份与恢复：完全备份 Full backup；增量备份 Incremental backup;

## 8.基于日志系统的文件结构

## 9.NFS

- 网络文件系统与RPC

## 10.实例：WAFL文件系统

- 为特定的文件负载，提供性能优化，网络文件服务系统，分布式文件系统
- 解决：大量随机IO写入问题
- 关键：利用前提带有稳定存储缓冲的（硬件）特性，优化文件系统随机IO
- 创建快照：增量修改块

## 总结

- 1.磁盘分区理由：
  - a.在同一磁盘上支持不同的文件系统；
- 2.文件系统结构：
  - a.底层处理存储设备的物理属性：设备驱动程序，IO控制，基本文件系统；
  - b.高层处理符号文件名和文件逻辑属性：逻辑文件系统，应用程序；
  - c.中间层将逻辑文件概念映射到物理设备属性：文件组织模块；
- 3.文件系统结构和算法：VFS
- 4.文件在磁盘空间分配方法：
  - a.连续分配:处理外部碎片问题；区域扩展
  - b.链表分配:解决直接访问效率问题；FAT
  - c.索引分配:解决索引块空间使用问题；按簇分配
- 5.空闲空间分配方法：
  - a.位向量；
  - b.链表:优化：组合、计数、FAT
- 6.目录管理：哈希表
- 7.一致性检查：如何进行
- 8.网络文件系统：NFS
- 9.WAFL特点和应用