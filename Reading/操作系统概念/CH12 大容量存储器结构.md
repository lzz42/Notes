# CH12 大容量存储器结构

## 1.大容量存储器介绍

- 什么是大容量存储器？
  - 磁盘 magnetic disk:磁臂disk arm,磁道 track,磁头
  - 磁盘结构：磁盘->盘片->磁道->扇区sector
  - 存储容量 ＝ 磁头数 × 磁道(柱面)数 × 每条磁道扇区数 × 每扇区字节数
  - 传输速率：tansfer rate;定位时间（随机访问时间 random access time）：positioning time = 寻道时间（seek time）+ 旋转等待时间（rotational latency）
  - [磁盘结构](https://www.cnblogs.com/joydinghappy/archive/2012/05/21/2511948.html)

- 磁盘IO操作：PC--端口映射-->host controller--send cmd--IO bus-->disk controller --执行指令-->返回数据--IO bus-->host controller-->PC

|名称|翻译|
|:----|:----|
|磁盘|magnetic disk|
|磁臂|disk arm|
|磁道|track|
|柱面|cylinder|
|扇区|sector|
|传输速率|transfer rate|
|定位时间|positioning time|
|随机访问时间|random access time|
|寻道时间|seek time|
|旋转等待时间|rotational latency|
|软盘|floppy disk|
|I/O总线|I/O bus|
|EIDE|enhanced integrated drive electrionics|
|ATA| advanced technology attachment|
|串行ATA| serial ATA，SATA|
|USB|universal serial bus |
|FC|fiber channel|
|控制器|controller|
|主机控制器|host controller|
|磁盘控制器|disk controller|
|磁带|magnetic type|
|火线|fire wire|
|常量线性速度|constant linear velocity CLV|
|恒定圆角速度|contant angluar velocity CAV|

## 2.磁盘结构

- 一维的逻辑块数组；扇区0：最外柱面的第一个磁道的第一个扇区；映射顺序：磁道内扇区；柱面内磁道；从外到内的柱面；
- 保存磁头续写速度恒定

## 3.磁盘附属

- 计算机访问磁盘两种主要方式：
  - 1.通过I/O端口：主机附属存储host-attached storage
  - 2.通过分布式文件系统：network-attached storage
- 主机附属存储 host-attached storage
  - I/O总线结构：IDE，ATA，SATA
  - SCSI，FC
  - SCSI：总线结构，SCSI协议在一根总线上可支持16个设备（一个控制卡SCSI引导器；15个目标设备）
  - FC：告诉串行结构，大交换结构（存储区域网络SAN）；裁定循环FC-AL
- 网络附属存储 network-attached storage NAS

## 4.磁盘调度

- 目的：有效使用硬件；较快的访问速度和较宽的磁盘带宽
- 访问时间：
  - 1.寻道时间：将disk arm 移动到目标扇区所在磁道的时间；
  - 2.旋转延迟：将目标扇区转动到head下的时间；
- 磁盘带宽：传递的总字节数除以从服务请求开始到最后传递结束的时间；
- 了解系统调用-IO操作：
  - 1.操作类型：输入、输出；
  - 2.传输的磁盘地址；
  - 3.传输的内存地址；
  - 4.传输的扇区数；
- 磁盘驱动器的请求队列：当磁盘处于非空闲状态时，对于到达的操作请求会放入磁盘驱动器的待处理队列中，对于该队列中的请求如何进行调度处理问题？涉及到硬件优化
- FCFS First Coming Fisrt Service
  - 先来先服务算法：
  - 内容：服务队列中先到的请求优先进行处理
  - 特点：算法简单，比较公平，没有饥饿
  - 缺点：性能不高；
- SSTF shorttest-seek-time-first
  - 最短寻道时间优先算法
  - 内容：选择距离当前磁头最短寻道时间的请求进行处理
  - 特点：性能比FCFS高三分之一
  - 缺点：可能会导致饥饿，不是最优算法
- SCAN
  - 扫描调度 电梯算法（elevator algorithm）
  - 内容：disk arm从磁盘的一端向另一端进行移动，当head经过每个柱面时，处理该柱面上的队列中的请求，到达另一端时改变方向继续进行扫描处理；
  - 特点：不存在饥饿，但等待时间可能存在不均匀
  - 缺点：不是最优算法，磁头在整个磁盘宽度扫描
- C-SCAN
  - circular SCAN算法
  - 内容：Head从磁盘的一端扫描到磁盘另一端，head经过每个柱面时，处理该柱面上的请求，但是返回时不处理请求，快速返回，并重新开始扫描
  - 缺点：不是最优算法，磁头在整个磁盘宽度扫描
- Look
  - 内容：磁头只移动处理到一个方向的最远请求距离，然后马上回头移动处理到另一个方向的最远请求距离，如此往复处理；
  - L--Head-->R--Head-->L--Head-->R
  - 特点：不存在饥饿，但等待时间可能存在不均匀
- C-LOOK
  - 内容：磁头只移动处理到一个方向的最远请求距离，然后马上回头移动到另一个方向的最远请求距离，但次过程中不处理请求，如此往复处理；
- 调度算法的选择问题
  - 考量因素：请求的数量；请求类型；文件分配方法；目录与索引块的位置；旋转等待时间；

## 5.磁盘管理

- 主要涉及：磁盘格式化、磁盘引导、坏块的处理
- 磁盘格式化：
  - 低级格式化（物理格式化）：将磁盘分割成磁盘控制器能够读写的扇区的过程；
  - 能够读写：格式化将扇区设置为特定的数据结构：
    - 扇区数据结构：
    - 1.头部、尾部：功能区，包含扇区号码、纠错代码ECC（error-correcting code）
    - 2.数据区域：存储数据区，通常大小为512B
    > ECC：根据数据区域计算出来的纠错值，写入时，根据写入数据更新ECC，读取时，根据读取数据校验ECC，若校验失败出现软错误（soft error）
- 磁盘存取文件前工作：
  - 1.将磁盘根据柱面建立分区；
  - 2.逻辑格式（创建文件系统），将初始的文件系统数据结构存储到磁盘上
- 特殊：
  - 1.簇（cluster）的出现：提高效率，将多个块集中到一大块，称为cluster，磁盘I/O使用块，而文件系统I/O使用cluster，通过提供更多的顺序访问提高效率
  - 2.生磁盘（raw disk）的出现：将磁盘分区作为一个逻辑块的大顺序数组，没有文件系统，提供给特殊的应用程序使用
- 引导块
  - [计算机启动过程](http://www.ruanyifeng.com/blog/2013/02/booting.html)：
    - 第一阶段：BIOS
      > 计算机加电后，读取只读ROM内的开机程序即BISO，basic Input/Output System;
      - POST 硬件自检
      > BIOS检测硬件状态，即硬件自检 Power-On Self-Test
      - 启动顺序
      > 自检完成后，BIOS确定外部存储设备排序以转移控制权，Boot Sequence，即启动项设定
    - 第二阶段：MBR 主引导记录
      - BIOS根据启动顺序将控制转移给第一存储设备，计算机读取该设备第一扇区（一般512B）,若该扇区最后两个字节是0x55或者0xAA则表示该设备可以启动,若不是则控制权交给第二个存储设备
      - 主引导记录 Master Boot Record：第一个扇区的512B，主要记录寻找操作系统的位置
      > MBR结构：
        > 1.第1-446字节:调用操作系统的机器码；
        > 2.第447-510字节：分区表（Partition Table）
        > 3.第511-512字节：主引导记录签名（0x55和0xAA）
      - 分区表
        - 长度：64字节；分为4项；每项16字节；一个硬盘最多分4个一级分区即主分区；
        - 每个主分区结构（16B）：
          - 1.第1字节：是否为激活分区标识是否为0x80;
          - 2.第2-4个字节：主分区第一个扇区物理位置（柱面，磁头，扇区号）；
          - 3.第5个字节：主分区类型
          - 4.第6-8个字节：主分区最后一个扇区物理位置；
          - 5.第9-12个字节：主分区第一个扇区的逻辑地址；
          - 6.第13-16字节：主分区的扇区总数；（即限制了主分区的扇区数：2^32，对于512扇区为2T，扩大硬盘：1.提高扇区字节数；2.增加扇区总数；）
    - 第三阶段：硬盘启动
      - 找到并加载操作系统，将控制转移给操作系统
      - 计算机将控制交给硬盘的某个分区：
      - 三种情况：
        - A：卷引导记录 计算机读取激活分区的第一个扇区（卷引导记录VBR Volume Boot Record），获取计算机操作系统在该分区的位置，然后加载OS
        - B：扩展分区和逻辑分区 扩展分区（Extended Partition）：四主分区无法使用较大硬盘时，四主分区中有且仅有一个被用作扩展分区，扩展分区内分成多个逻辑分区（Logical Partition）  > 计算机首先读取扩展分区的第一个扇区（扩展引导记录EBR Extended Boot Record）,内含有64B的分区表，但最多只有两个逻辑分区，然后计算机读取第二个逻辑分区的第一个扇区，找到第三个分区的位置，如此直到某个逻辑分区表包含自身为止，即只有一个分区
        - C：启动管理器 此时计算机读取MBR后，不把控制交给某个分区，而是启动安装的启动管理器（Boot Loader），由用户选择启动的操作系统，EG：Linux中一般使用Grub
        - D：操作系统 控制转移到OS后，首先加载（读入内存）OS内核，然后加载各个模块，启动操作系统流程；
  - 自举程序Bootstrap:保存在ROM中
  - MBR结构：引导代码；分区表；
- 坏块
  - 坏块的处理方式：
    - 1.手工处理，运行特殊处理程序，一般适用于简单磁盘
    - 2.维护坏块列表：使用备用块替换坏块，即扇区备用（sector sparing）或转寄(forwarding),扇区滑动（sector slipping）

## 6.交换空间管理

- 交换（swapping）和分页（paging）
- 交换空间管理：为虚拟内存提供最佳吞吐量
- 交换空间的使用：
  - 根据具体操作系统的内存管理算法，具体使用交换空间
  - 注意：对交换空间数量的高估要比低估更加安全，原因：系统用完交换空间后，可能会中断进程或整个操作系统；
- 交换空间位置：
  - 1.普通文件系统或者独立的磁盘分区：
  - 2.独立的生磁盘：
- 交换空间管理：

## 7.RAID结构

- RAID：磁盘冗余阵列，用于提高性能和可靠性；
- 通过冗余改善可靠性
  - 引入冗余后，磁盘出错后，可根据冗余信息进行恢复
  - 引入冗余的方法：
    - 磁盘镜像mirroring：
    - 电源掉电处理：
      - 1.先写一个副本，再写另一个；
      - 2.将RAM加载到RAID阵列，电源掉电时，写回高速缓存收到保护
- 通过并行处理改善性能
  - 改善传输速率：1.分散数据，位级分散：分散数据的每个字节的每个位；块级分散
  - 1.通过负载平衡，增加多个小访问的吞吐量；
  - 2.降低大访问的响应时间；
- RAID级别
  - 什么是RAID级别？
  - 不同的磁盘分散和奇偶位的磁盘组织方案的分级，P：差错纠正位；C：数据镜像；
  - RAID 0:按块级分散的RAID，无冗余，DDDD；
  - RAID 1：磁盘镜像，DDDDCCCC
  - RAID 2：内存方式的差错纠正结构：DDDDPPP，基于奇偶位的内存检测
  - RAID 3：基于位交织的奇偶结构
  - RAID 4：基于块交织的奇偶结构
  - RAID 5：分布交织的奇偶结构
  - RAID 6：P+Q冗余方案
- RAID级别的选择
  - 考虑因素：重建性能
- 扩展
  - InServ存储阵列：可以在文件系统动态扩展磁盘
- RAID问题
  - 不能一直保证数据对于OS或者使用者是可用的
  - 解决：Solaris ZFS

## 8.稳定存储的实现

- 