# CH13 IO输入系统

## 1.概述

- 设备驱动程序

## 2.IO硬件

- 总线，控制器
- IO端口，寄存器，设备控制器：

### 2.2 中断

- 中断基本机制：
  - 1.CPU硬件：一条中断请求线（Interrupt-request line，IRL）
  - 2.CPU执行完每条指令后，检测IRL是否具有中断信号；
  - 3.若检测到中断信号，CPU保存当前状态，CPU跳转到内存固定位置的中断处理程序，中断处理程序进行中断处理
  - 4.中断处理完后，CPU返回中断前位置，恢复中断前状态，继续执行
  - 5.若未检测到中断信号，CPU继续执行下一条指令
- IO设备引起中断 raise--->CPU捕获中断 catch--->CPU分发中断dispatch--->中断处理程序处理中断，设备清除中断状态clear
- 中断处理特性：
  - 1.CPU进行关键处理时，CPU能延迟中断处理；
  - 2.CPU更为有效的中断分发到合适的中断处理程序；
  - 3.多级中断，OS区分中断优先级和紧迫性；
- 中断控制器interrupt-controller
- CPU中断请求线：
  - 1.非屏蔽中断
  - 2.可屏蔽中断
- 中断向量interrupt vector：
- 中断优先级interrupt priority
- OS启动时，OS检测硬件状态，将硬件的中断处理程序安装到中断向量
- 中断与OS交互：
  - 1.虚拟内存分页
  - 2.系统调用
  - 3.管理内核控制流
- 总结：
  - 1.处理异步事件
  - 2.设置陷阱进入内核模式

### 直接内存访问

- 处理大量传输设备问题：Programmed IO PIO
- 专用处理器：直接内存访问处理器（DMA direct-memory access）
- 处理大量数据：CPU---发送DMA命令--->DMA--->IO设备控制器
- DMA与设备控制器
  - 握手：DMA-request线，DMA-acknowledge线
- 周期挪用 cycle stealing
- 直接虚拟内存访问 direct virtual-memory access DVMA

### IO硬件总结：

- 1.总线
- 2.控制器
- 3.IO端口与寄存器
- 4.主机与设备控制器之间握手关系
- 5.通过轮询检测或者中断进行握手
- 6.将大量传输任务下放给DMA控制器

## IO应用接口

- IO设备特点：
  - 1.数据传输模式：字节流、块；
  - 2.访问方法：随机访问、顺序访问；
  - 3.传输调度：同步、异步；
  - 4.共享：专用、可共享；
  - 5.设备速度：
  - 6.IO方向：只读、只写、读写；
- 块与字节流设备：
  - 1.原始IO、直接IO
  > 内存映射：
  > 1.为何内存映射IO比较高效？
  > 首先，内存映射不提供read和write操作，通过直接操作内存的字节数组操作磁盘存储；
  > 其次，字节数组的由来：内存映射的系统调用返回一个字节数组的虚拟内存地址，该字节数组即文件的副本；
  > 其次，实际数据传输在需要时才进行，以满足内存映像访问；
  > 最后，数据传输采用与按需分页虚拟内存访问相同的机制；
- 网络设备：一般使用socket接口进行网络IO
- 时钟与定时器
  - 可编程间隔定时器promgrammable interval timer
- 阻塞与非阻塞IO

## 13.4 IO子系统

- IO子系统作用：提供与IO相关的服务：调度、缓存、高速缓存、假脱机、设备预留、错误处理，以及提供自己免受错误进程和恶意用户危害

### 13.4.1 IO调度

- 目的：改善系统整体性能进程公平共享IO设备，减少IO平均等待时间
- 每个设备维护一个请求队列，进行调度
- 异步IO跟踪设备IO请求：设备状态表（device status table）：包含每一个IO设备的条目（设备类型，地址，设备状态）

### 13.4.2 缓冲

- 什么是缓冲？
- A:保存两个设备之间或设备和应用程序间的所传输数据的内存区域。
- 为什么需要缓冲？
- A：数据流的生产者和消费者存在处理数据的速度差异；（双缓冲）
- A:协调传输数据大小不一致的设备；（网络消息分段和重组）
- A:支持应用程序的IO复制语义；（OS保证写入磁盘的数据就是write系统调用发生时的数据版本，内核缓冲与应用程序数据空间）

### 13.4.3 高速缓存cache

- 什么是高速缓存？
- A:可以保留数据的高速缓存器；
- 缓冲与高速缓存区别：
- A:缓冲：可能是数据项的唯一副本；而高速缓存是驻留在其他地方的数据的副本；

### 13.4.4 假脱机与设备预留

- 什么是假脱机（spooling）？
- A:保存不能接收交叉数据流的设备输出的缓冲区，是OS协调并发输出的方法；
- 协调并发输出的方法有哪些？
- A:1.假脱机；2.提供协调工具；

### 13.4.5 错误处理

- IO系统调用返回一个位表示状态信息（success or failed）

### 13.4.6 IO保护

- 防止用户执行非法IO，定义所有IO指令为特权指令
- 所有内存映射和IO端口内存位置都受到内存系统保护，阻止用户访问

### 13.4.7 内核数据结构

- 目的：用来保存IO组件的状态信息
- UNIX：采用若干实体，实体都支持类似操作，但语义不一样；
- WindowsNT：使用消息传递

### 13.4.8 内核IO子系统小结

- IO子系统用途：为应用程序和内核其他部分提供了一个可扩展的服务集合；
- 负责任务：
  - 1.文件和设备的命名空间的管理；
  - 2.文件和设备的访问控制；
  - 3.操作控制；
  - 4.文件系统空间分配；
  - 5.设备分配；
  - 6.缓冲、高速缓存、假脱机；
  - 7.IO调度；
  - 8.设备状态监控、错误处理、失败恢复；
  - 9.设备驱动程序配置和初始化；

## 13.5 把IO操作转换成硬件操作

- 从文件名到磁盘控制器（硬件端口地址或内存映射控制器寄存器）的连接，是如何建立的？
- A：1.MS-DOS:通过冒号分割-设备映射表；UNIX：设备名称空间集成到普通文件系统名称空间-装配表（mount table）；
- IO阻塞请求过程：
  - 1.进程对于打开的文件描述符调用阻塞的read()系统调用；
  - 2.内核系统调用代码检查参数正确性。若数据在高速缓存中，则将数据返回进程并完成IO调用；
  - 3.否则，发起物理IO请求，进程从运行队列移动到设备等待队列，调度IO请求；
  - 4.IO子系统对设备驱动程序发出IO请求（可通过子系统调用或者消息传递方式发送）；
  - 5.设备驱动程序分配内核缓冲区内存，以准备接收数据，调度IO，然后设备驱动程序通过写入设备控制寄存器对设备控制器发送指令；
  - 5.设备控制器 控制 设备执行数据传输操作；
  - 6.设备驱动程序轮询检测状态和数据，或通过DMA将数据传入内核内存，对于DMA则在完成后产生中断，或驱动程序检测到传输完成状态；
  - 7.中断处理程序处理中断或者驱动程序处理完成状态，保存数据，并向内核设备驱动程序发送信号通知；
  - 8.设备驱动程序接收到信号，确定IO完成，确定请求状态，然后项内核IO子系统发送信号，通知请求完成；
  - 9.内核将数据或返回传递给请求的进程的地址空间，并将进程从等待队列移入就绪队列；
  - 10.进程进入就绪队列后，等待CPU调度后，继续执行。
  - 总体请求逻辑：`用户进程--->内核IO子系统--->设备驱动器--->设备控制器--->设备操作--->中断处理程序--->内核IO子系统--->用户进程`

## 13.6 流

- 什么是流？
- A:UNIX V的机制，让应用程序动态的组合驱动程序代码流水线；
- 工作环节：在设备驱动程序和用户进程之间全双工连接；
- 组成：流开始（stream head）、驱动程序结尾、若干流模块；
- 每个组成部分都有两种队列：读队列、写队列；队列之间通过消息进行数据传输；
- 流控制：防止队列溢出
- 流方式提供了一个框架，使用模块化和递增方式编写设备驱动程序和网络协议；

## 13.7 性能

- IO导致的性能损耗：
  - 1.进程阻塞导致进程调度；
  - 2.进程调度导致上下文切换；
  - 3.进程调度导致高速缓存负担；
  - 4.IO中断的影响；
- 改善效率原则：
  - 1.减少上下文切换次数；
  - 2.减少设备和应用程序之间数据传递时在内存之间数据复制次数；
  - 3.减少中断频率；
  - 4.采用MDA和通道负责简单数据复制，增加并发；
  - 5.将处理原语移入硬件，允许控制器内的操作与CPU和总线内的操作并发；
  - 6.平衡CPU、内存子系统、总线、IO性能；
- IO功能实现：
  - 1.应用程序实现：由于上下文切换问题，实现效率较低；
  - 2.内核实现：
  - 3.设备或控制器实现：

## 13.8 总结

- IO硬件基本构成；
- 内核IO子系统的服务；
- 流的在IO中的使用；
- IO性能问题讨论；
